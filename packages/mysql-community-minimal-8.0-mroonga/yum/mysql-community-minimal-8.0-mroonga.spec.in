# -*- sh-shell: rpm -*-

%define mysql_version_default 8.0.40
%define mysql_release_default 1
%define mysql_dist_default    el%{rhel}
%define mysql_spec_file_default mysql.spec

%define _mysql_version %{?mysql_version:%{mysql_version}}%{!?mysql_version:%{mysql_version_default}}
%define _mysql_release %{?mysql_release:%{mysql_release}}%{!?mysql_release:%{mysql_release_default}}
%define _mysql_dist %{?mysql_dist:%{mysql_dist}}%{!?mysql_dist:%{mysql_dist_default}}
%define _mysql_spec_file %{?mysql_spec_file:%{mysql_spec_file}}%{!?mysql_spec_file:%{mysql_spec_file_default}}

%define groonga_required_version @REQUIRED_GROONGA_VERSION@

Name:		mysql-community-minimal-8.0-mroonga
Version:	@VERSION@
Release:	2%{?dist}
Summary:	A fast fulltext searchable storage engine for MySQL

Group:		Applications/Databases
License:	LGPLv2.1
URL:		https://mroonga.org/
Source0:	https://packages.groonga.org/source/mroonga/mroonga-%{version}.tar.gz

BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-%(%{__id_u} -n)
BuildRequires:	cmake
BuildRequires:	dnf-command(download)
BuildRequires:	groonga-devel >= %{groonga_required_version}
BuildRequires:	groonga-normalizer-mysql-devel
BuildRequires:	libcurl-devel
BuildRequires:	mysql-community-devel = %{_mysql_version}-%{_mysql_release}.%{_mysql_dist}
BuildRequires:	ninja-build
BuildRequires:	rpm
BuildRequires:	sed
Requires:	mysql-community-server-minimal = %{_mysql_version}-%{_mysql_release}.%{_mysql_dist}
Requires:	groonga-libs >= %{groonga_required_version}
Requires:	groonga-normalizer-mysql

%description
Mroonga is a fast fulltext searchable storage plugin for MySQL.
It is based on Groonga that is a fast fulltext search engine and
column store. Groonga is good at real-time update.

%prep
%setup -q -n mroonga-%{version}

if ! cp /mysql-community-*.src.rpm ./; then
  dnf download -y ${quiet} --source mysql-community
fi
rpm -Uvh mysql-community-*.src.rpm
sed -i'' -e 's/^  make /  # make /' ~/rpmbuild/SPECS/%{_mysql_spec_file}
sed -i'' -e 's/^  cmake3 /  cmake /' ~/rpmbuild/SPECS/%{_mysql_spec_file}

%build
rpmbuild -bc ~/rpmbuild/SPECS/%{_mysql_spec_file}
mysql_source=$HOME/rpmbuild/BUILD/mysql-%{_mysql_version}/mysql-%{_mysql_version}
mysql_build=$HOME/rpmbuild/BUILD/mysql-%{_mysql_version}/release
make -C ${mysql_build}/utilities %{?_smp_mflags} GenError
%cmake \
  -DMYSQL_BUILD_DIR=${mysql_build} \
  -DMYSQL_CONFIG=${mysql_build}/scripts/mysql_config \
  -DMYSQL_SOURCE_DIR=${mysql_source} \
  -GNinja \
  %{?mroonga_cmake_options}
cmake --build %{__cmake_builddir}

%install
rm -rf $RPM_BUILD_ROOT
%cmake_install

%clean
rm -rf $RPM_BUILD_ROOT

%files
%defattr(-,root,root,-)
%{_libdir}/mysql/plugin/
%{_datadir}/mroonga/*

%changelog
* Tue Oct 15 2024 Horimoto Yasuhiro <horimoto@clear-code.com> - 14.08-2
- Rebuilt against MySQL 8.0.40.

* Thu Sep 26 2024 Horimoto Yasuhiro <horimoto@clear-code.com> - 14.08-1
- New upstream release.

* Fri Sep 06 2024 Horimoto Yasuhiro <horimoto@clear-code.com> - 14.07-1
- New upstream release.
