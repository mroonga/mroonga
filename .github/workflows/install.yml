name: Install to Ubuntu
on:
  schedule:
    - cron: |
        0 0 * * *
concurrency:
  group: ${{ github.head_ref || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true
jobs:
  install:
    name: Install to Ubuntu
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: "images:ubuntu/20.04"
            package: mysql
          - image: "images:ubuntu/22.04"
            package: mariadb
          - image: "images:ubuntu/22.04"
            package: mysql
    steps:
      - uses: actions/checkout@v4
      - name: Install Incus
        run: |
          # We can use the official Ubuntu APT repository when
          # ubuntu-latest is Ubuntu 24.04.
          sudo curl -fsSL https://pkgs.zabbly.com/key.asc -o /etc/apt/keyrings/zabbly.asc
          cat <<SOURCES | sudo tee /etc/apt/sources.list.d/zabbly-incus-stable.sources
          Enabled: yes
          Types: deb
          URIs: https://pkgs.zabbly.com/incus/stable
          Suites: $(. /etc/os-release && echo ${VERSION_CODENAME})
          Components: main
          Architectures: $(dpkg --print-architecture)
          Signed-By: /etc/apt/keyrings/zabbly.asc
          SOURCES

          sudo apt update
          sudo apt install -y -V incus
      - name: Prepare container
        run: |
          set -x
          sudo incus admin init --auto
          sudo incus launch ${{ matrix.image }} target
          sudo incus config device add target host disk source=$PWD path=/host
      - name: Install Mroonga
        run: |
          sudo incus exec target \
            -- \
            /host/packages/apt/install_test.sh \
              ${{ matrix.package }}-mroonga
      - name: Delete container
        run: |
          sudo incus stop target
          sudo incus delete target
